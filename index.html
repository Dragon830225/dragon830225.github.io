<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Au√üer-Haus Liefer-App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: auto;
      padding: 1rem;
      font-size: 18px;
      line-height: 1.5;
    }
    h1, h2 {
      text-align: center;
      margin-bottom: 1rem;
    }
    ul {
      list-style: none;
      padding: 0;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      background: #f8f8f8;
    }
    li {
      padding: 10px 12px;
      border-bottom: 1px solid #ddd;
      background: #fff;
      cursor: grab;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    li.dragging {
      opacity: 0.5;
    }
    li:last-child {
      border-bottom: none;
    }
    button {
      padding: 8px 14px;
      margin: 0 5px;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #888;
      background: #eee;
      font-size: 16px;
      transition: background 0.3s;
    }
    button:hover {
      background: #ddd;
    }
    #admin {
      display: none;
      margin-top: 20px;
      border-top: 2px solid #333;
      padding-top: 15px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input[type=text] {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      box-sizing: border-box;
      font-size: 16px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #addCustomerForm {
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      padding: 12px;
      border-radius: 6px;
      background: #f0f0f0;
    }
    /* Modal Styles */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 1000; 
      left: 0; top: 0; width: 100%; height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.5); 
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto; 
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
      font-size: 16px;
    }
    .modal-content h3 {
      margin-top: 0;
    }
    .modal-content label {
      font-weight: normal;
    }
    .modal-buttons {
      text-align: right;
      margin-top: 15px;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJcjqAjlyrbiojweyXFOLMrelTsHSFog0",
      authDomain: "ausser-haus.firebaseapp.com",
      databaseURL: "https://ausser-haus-default-rtdb.firebaseio.com",
      projectId: "ausser-haus",
      storageBucket: "ausser-haus.appspot.com",
      messagingSenderId: "919348966579",
      appId: "1:919348966579:web:8cdbe342868eb6013eecc6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let isAdmin = false;
    let kundenData = {};
    let kundenOrder = [];
    const wochenTage = ["montag", "dienstag", "mittwoch", "donnerstag", "freitag", "samstag", "sonntag"];

    // --- Drag & Drop f√ºr Kundenliste ---
    let dragged;

    function dragStart(e) {
      dragged = e.target;
      e.target.classList.add("dragging");
    }
    function dragEnd(e) {
      e.target.classList.remove("dragging");
      dragged = null;
    }
    function dragOver(e) {
      e.preventDefault();
      const list = e.currentTarget;
      const afterElement = getDragAfterElement(list, e.clientY);
      if (afterElement == null) {
        list.appendChild(dragged);
      } else {
        list.insertBefore(dragged, afterElement);
      }
    }
    function drop(e) {
      e.preventDefault();
      // Update kundenOrder
      const list = document.getElementById("customers");
      kundenOrder = Array.from(list.children).map(li => li.dataset.key);
      set(ref(db, "kundenOrder"), kundenOrder);
    }
    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll("li:not(.dragging)")];
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Kunden rendern
    function renderKunden() {
      const list = document.getElementById("customers");
      list.innerHTML = "";
      const sortierteKeys = kundenOrder.length ? kundenOrder : Object.keys(kundenData);

      sortierteKeys.forEach(key => {
        const data = kundenData[key];
        if (!data) return;
        const li = document.createElement("li");
        li.dataset.key = key;
        li.textContent = `${data.name}, ${data.strasse}, ${data.ort}`;

        if (isAdmin) {
          li.setAttribute("draggable", true);
          li.style.cursor = "grab";

          // L√∂schen-Button
          const delBtn = document.createElement("button");
          delBtn.textContent = "üóëÔ∏è";
          delBtn.title = "Kunden l√∂schen";
          delBtn.onclick = (e) => {
            e.stopPropagation();
            if(confirm(`Kunden "${data.name}" wirklich l√∂schen?`)) {
              remove(ref(db, `kunden/${key}`));
              // Kunden-Order neu speichern ohne diesen Key
              kundenOrder = kundenOrder.filter(k => k !== key);
              set(ref(db, "kundenOrder"), kundenOrder);
            }
          };
          li.appendChild(delBtn);

          li.addEventListener("dragstart", dragStart);
          li.addEventListener("dragend", dragEnd);
        }
        list.appendChild(li);
      });
      if (isAdmin) {
        const list = document.getElementById("customers");
        list.addEventListener("dragover", dragOver);
        list.addEventListener("drop", drop);
      }
    }

    // Kunden neu hinzuf√ºgen (Admin)
    function addKunde(e) {
      e.preventDefault();
      const name = document.getElementById("newName").value.trim();
      const strasse = document.getElementById("newStrasse").value.trim();
      const ort = document.getElementById("newOrt").value.trim();

      if (!name || !strasse || !ort) {
        alert("Bitte alle Felder ausf√ºllen!");
        return;
      }

      const newRef = push(ref(db, "kunden"));
      newRef.set({ name, strasse, ort });

      // Kundenreihenfolge aktualisieren
      kundenOrder.push(newRef.key);
      set(ref(db, "kundenOrder"), kundenOrder);

      // Formular zur√ºcksetzen
      document.getElementById("addCustomerForm").reset();
    }

    // Men√º-Modal √∂ffnen und schlie√üen
    function openMenuModal(menuData) {
      const modal = document.getElementById("menuModal");
      modal.style.display = "block";

      wochenTage.forEach(tag => {
        const input = document.getElementById("menu_" + tag);
        input.value = (menuData && menuData[tag]) ? menuData[tag] : "";
      });
    }
    function closeMenuModal() {
      document.getElementById("menuModal").style.display = "none";
    }
    function saveMenu(e) {
      e.preventDefault();
      const updates = {};
      wochenTage.forEach(tag => {
        const val = document.getElementById("menu_" + tag).value.trim();
        updates[tag] = val;
      });
      set(ref(db, "menue"), updates);
      alert("Men√º gespeichert!");
      closeMenuModal();
    }

    // Men√º rendern (f√ºr Fahrer nur heute, f√ºr Admin Button)
    function renderMenue(menuData) {
      const menuList = document.getElementById("menu");
      menuList.innerHTML = "";

      if (isAdmin) {
        const btn = document.createElement("button");
        btn.textContent = "Men√º f√ºr ganze Woche bearbeiten";
        btn.onclick = () => openMenuModal(menuData);
        menuList.appendChild(btn);
      } else {
        // Fahrer sehen nur heutigen Tag
        const today = new Date().toLocaleDateString("de-DE", { weekday: "long" }).toLowerCase();
        const text = (menuData && menuData[today]) ? menuData[today] : "Kein Eintrag";
        const li = document.createElement("li");
        li.textContent = `${today.charAt(0).toUpperCase() + today.slice(1)}: ${text}`;
        menuList.appendChild(li);
      }
    }

    // Daten laden
    function loadData() {
      onValue(ref(db, "kunden"), (snapshot) => {
        kundenData
