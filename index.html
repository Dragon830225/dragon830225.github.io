<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Au√üer-Haus Liefer-App</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 1rem; }
    ul { list-style: none; padding: 0; }
    li { padding: 8px; border: 1px solid #ccc; margin-bottom: 5px; background: #f9f9f9; cursor: grab; }
    li.dragging { opacity: 0.5; }
    label { display: block; margin-top: 10px; }
    input[type=text] { width: 100%; padding: 6px; box-sizing: border-box; }
    button { margin-top: 10px; padding: 8px 12px; cursor: pointer; }
    #admin { display: none; margin-top: 20px; padding-top: 10px; border-top: 2px solid #333; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJcjqAjlyrbiojweyXFOLMrelTsHSFog0",
      authDomain: "ausser-haus.firebaseapp.com",
      databaseURL: "https://ausser-haus-default-rtdb.firebaseio.com",
      projectId: "ausser-haus",
      storageBucket: "ausser-haus.appspot.com",
      messagingSenderId: "919348966579",
      appId: "1:919348966579:web:8cdbe342868eb6013eecc6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let isAdmin = false;
    let kundenData = {};
    let kundenOrder = [];

    // Wochentage deutsch, klein, f√ºr Men√º-Keys
    const wochenTage = ["montag", "dienstag", "mittwoch", "donnerstag", "freitag", "samstag", "sonntag"];

    // Kunden anzeigen mit Drag & Drop f√ºr Admin
    function renderKunden() {
      const list = document.getElementById("customers");
      list.innerHTML = "";

      // Sortiere nach kundenOrder, falls vorhanden
      const sortierteKeys = kundenOrder.length ? kundenOrder : Object.keys(kundenData);

      sortierteKeys.forEach(key => {
        const data = kundenData[key];
        if (!data) return;
        const li = document.createElement("li");
        li.setAttribute("draggable", isAdmin);
        li.dataset.key = key;
        li.textContent = `${data.name}, ${data.strasse}, ${data.ort}`;
        if (isAdmin) {
          li.style.cursor = "grab";
          li.addEventListener("dragstart", dragStart);
          li.addEventListener("dragend", dragEnd);
        }
        list.appendChild(li);
      });
      if (isAdmin) {
        // Drag & Drop Events f√ºr Liste
        list.addEventListener("dragover", dragOver);
        list.addEventListener("drop", drop);
      }
    }

    // Drag & Drop Handlers
    let dragged;

    function dragStart(e) {
      dragged = e.target;
      e.target.classList.add("dragging");
    }
    function dragEnd(e) {
      e.target.classList.remove("dragging");
      dragged = null;
    }
    function dragOver(e) {
      e.preventDefault();
      const list = e.currentTarget;
      const afterElement = getDragAfterElement(list, e.clientY);
      if (afterElement == null) {
        list.appendChild(dragged);
      } else {
        list.insertBefore(dragged, afterElement);
      }
    }
    function drop(e) {
      e.preventDefault();
      // Aktualisiere kundenOrder nach neuer Reihenfolge
      const list = document.getElementById("customers");
      kundenOrder = Array.from(list.children).map(li => li.dataset.key);
      // Speichere neue Reihenfolge in Firebase
      set(ref(db, "kundenOrder"), kundenOrder);
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll("li:not(.dragging)")];
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Men√º rendern (f√ºr Admin ganze Woche, f√ºr Fahrer nur heutiges Gericht)
    function renderMenue(menuData) {
      const menuList = document.getElementById("menu");
      menuList.innerHTML = "";

      if (isAdmin) {
        // Formular mit allen Tagen
        const form = document.createElement("form");
        form.id = "menuForm";

        wochenTage.forEach(tag => {
          const label = document.createElement("label");
          label.textContent = tag.charAt(0).toUpperCase() + tag.slice(1);

          const input = document.createElement("input");
          input.type = "text";
          input.name = tag;
          input.value = menuData && menuData[tag] ? menuData[tag] : "";
          input.placeholder = "Gericht eingeben";

          label.appendChild(input);
          form.appendChild(label);
        });

        const submitBtn = document.createElement("button");
        submitBtn.type = "submit";
        submitBtn.textContent = "Men√º speichern";
        form.appendChild(submitBtn);

        form.onsubmit = e => {
          e.preventDefault();
          const updates = {};
          wochenTage.forEach(tag => {
            updates[tag] = form.elements[tag].value;
          });
          set(ref(db, "menue"), updates);
          alert("Men√º wurde gespeichert!");
        };

        menuList.appendChild(form);

      } else {
        // Fahrer sehen nur heutigen Tag
        const today = new Date().toLocaleDateString("de-DE", { weekday: "long" }).toLowerCase();
        const li = document.createElement("li");
        li.textContent = `${today.charAt(0).toUpperCase() + today.slice(1)}: ${menuData && menuData[today] ? menuData[today] : "Kein Eintrag"}`;
        menuList.appendChild(li);
      }
    }

    // Daten laden & anzeigen
    function loadData() {
      onValue(ref(db, "kunden"), (snapshot) => {
        kundenData = snapshot.val() || {};
        renderKunden();
      });
      onValue(ref(db, "kundenOrder"), (snapshot) => {
        kundenOrder = snapshot.val() || [];
        renderKunden();
      });
      onValue(ref(db, "menue"), (snapshot) => {
        renderMenue(snapshot.val());
      });
    }

    window.login = () => {
      const pw = prompt("Passwort eingeben:");
      if (pw === "1234") {
        isAdmin = true;
        document.getElementById("admin").style.display = "block";
        loadData();
      } else {
        alert("Falsches Passwort!");
      }
    };

    window.onload = () => {
      loadData();
    };
  </script>
</head>
<body>
  <h1>üçΩÔ∏è Au√üer-Haus Liefer-App</h1>
  <button onclick="login()">üîê Admin-Login</button>
  <hr>

  <h2>Kundendaten</h2>
  <ul id="customers">Wird geladen...</ul>

  <h2>Men√º</h2>
  <ul id="menu">Wird geladen...</ul>

  <div id="admin" style="display:none;">
    <p>Als Admin kannst du die Kunden per Drag & Drop verschieben und das Men√º f√ºr die ganze Woche eingeben.</p>
  </div>
</body>
</html>
